<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¤§é˜ªå†’éšª 2025 (é™¤éŒ¯ç‰ˆ)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- âš ï¸ Import Map: å®šç¾©æ¨¡çµ„è·¯å¾‘ -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.3.1",
        "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.3.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"
      }
    }
    </script>
    
    <!-- Babel (ç”¨æ–¼è§£æ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f6ea8c; color: #492540; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .pt-safe-top { padding-top: max(env(safe-area-inset-top), 16px); }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
        * { -webkit-tap-highlight-color: transparent; }
        
        /* Debug Panel Style */
        .debug-console {
            background: #2d2d2d;
            color: #4aff4a;
            font-family: monospace;
            font-size: 10px;
            padding: 10px;
            margin-top: 20px;
            border-top: 2px solid #492540;
            max-height: 200px;
            overflow-y: auto;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Main Logic -->
    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          MapPin, Coffee, ShoppingBag, Camera, CheckCircle, 
          Circle, Plus, Trash2, Edit2, Star, Navigation, 
          CloudSun, DollarSign, Calculator, Languages,
          ChevronDown, Copy, ArrowRight, X, AlertTriangle, Train, Car,
          Minus, FileText, Link as LinkIcon, Briefcase, Wallet,
          Clock, Tag, Save, Cloud, Loader, Check, Users, LogOut, UserCircle,
          Bug // Import Bug icon for debug
        } from 'lucide-react';

        // --- ğŸ”¥ Firebase Imports ---
        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "firebase/auth";
        import { getDatabase, ref, set, onValue, get, child } from "firebase/database";

        // --- ğŸ”§ Config Handling ---
        let firebaseConfig;
        
        // âš ï¸ è«‹ç¢ºèªé€™è£¡çš„é‡‘é‘°æ˜¯å¦æ­£ç¢º
        const DEFAULT_CONFIG = {
          apiKey: "AIzaSyBb-IBQ_PjoFm7ozqX8HTULLnA8SPw5yZo",
          authDomain: "osaka2025-kang.firebaseapp.com",
          databaseURL: "https://osaka2025-kang-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "osaka2025-kang",
          storageBucket: "osaka2025-kang.firebasestorage.app",
          messagingSenderId: "464521031058",
          appId: "1:464521031058:web:96dced14a80cdc6495254b"
        };

        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                firebaseConfig = DEFAULT_CONFIG;
            }
        } catch (e) {
            console.error("Config Error:", e);
            firebaseConfig = DEFAULT_CONFIG;
        }

        // --- ğŸ”¥ Firebase Initialization ---
        let app, auth, db;
        let initError = null;
        try {
            if (!firebaseConfig.databaseURL || (firebaseConfig.apiKey && firebaseConfig.apiKey.includes("API_KEY"))) {
                initError = "Config æœªå¡«å¯«å®Œæ•´ (ä½¿ç”¨äº†é è¨­ API_KEY)";
            } else {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app); 
            }
        } catch (e) {
            initError = e.message;
            console.error("Firebase Init Failed:", e);
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'osaka-adventure';

        // --- ğŸ’° Constants ---
        const USD_TO_JPY = 150; 
        const PAYERS = ['åª½åª½', 'å§Šå§Š', 'å¦¹å¦¹', 'å¼Ÿå¼Ÿ', 'çˆ¸çˆ¸', 'å…¬è²»'];

        // --- ğŸ“ è³‡æ–™åº« ---
        const LOCATIONS = {
          KIX: { name: 'é—œè¥¿åœ‹éš›æ©Ÿå ´ (KIX)', address: 'å¤§é˜ªåºœæ³‰ä½é‡å¸‚æ³‰å·ç©ºæ¸¯åŒ— 1', area: 'airport' },
          NAMBA_STATION: { name: 'å—æµ·é›£æ³¢ç«™', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®å€é›£æ³¢ 5-1-60', area: 'namba' },
          TAKASHIMAYA: { name: 'é«˜å³¶å±‹å¤§é˜ªåº—', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®å€é›£æ³¢ 5-1-5', area: 'namba' },
          KUROMON: { name: 'é»‘é–€å¸‚å ´', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®å€æ—¥æœ¬æ©‹ 2-4-1', area: 'namba' },
          DONKI_DOTONBORI: { name: 'é“é “å € å”å‰è¨¶å¾·', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®å€å®—å³è¡›é–€ç”º 7-13', area: 'namba' },
          GLICO: { name: 'é“é “å € Glico æ‹›ç‰Œ', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®å€é“é “å € 1-10-2', area: 'namba' },
          MUTEPPO: { name: 'ç„¡éµç‚®æ‹‰éºµ å¤§é˜ªåº—', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚æµªé€Ÿå€æˆæœ¬ç”º 1-5-21', area: 'daikoku' },
          HOME: { name: 'å¤§é˜ªæ°‘å®¿ (å¤§åœ‹ç”º)', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚æµªé€Ÿå€æˆæœ¬ç”º 1-5-21', area: 'daikoku' },
          KIZU_MARKET: { name: 'æœ¨æ´¥å¸å£²å¸‚å ´', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚æµªé€Ÿå€æ•·æ´¥æ± 2-2-8', area: 'daikoku' },
          KAIYUKAN: { name: 'å¤§é˜ªæµ·éŠé¤¨', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚æ¸¯å€æµ·å²¸é€š 1-1-10', area: 'bay' },
          TEMPOZAN: { name: 'å¤©ä¿å±±æ‘©å¤©è¼ª', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚æ¸¯å€æµ·å²¸é€š 1-1-10', area: 'bay' },
          UMEDA_SKY: { name: 'æ¢…ç”°è—å¤©å¤§å»ˆ', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚åŒ—å€å¤§æ·€ä¸­ 1-1-88', area: 'umeda' },
          HARUKAS: { name: 'é˜¿å€é‡ HARUKAS 300', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚é˜¿å€é‡å€é˜¿å€é‡ç­‹ 1-1-43', area: 'abeno' },
          QS_MALL: { name: 'é˜¿å€é‡ Qâ€™s Mall', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚é˜¿å€é‡å€é˜¿å€é‡ç­‹ 1-6-1', area: 'abeno' },
          YASAKA: { name: 'å…«å‚ç¥ç¤¾', address: 'äº¬éƒ½åºœäº¬éƒ½å¸‚æ±å±±å€ç¥‡åœ’ç”ºåŒ—å´ 625', area: 'kyoto' },
          KATSUKURA: { name: 'åä»£ç‚¸è±¬æ’ (ä¸‰æ¡)', address: 'äº¬éƒ½åºœäº¬éƒ½å¸‚ä¸­äº¬å€å¯ºç”ºé€šä¸‰æ¡ä¸‹ãƒ«', area: 'kyoto' },
          NISHIKI: { name: 'éŒ¦å¸‚å ´', address: 'äº¬éƒ½åºœäº¬éƒ½å¸‚ä¸­äº¬å€è¥¿å¤§æ–‡å­—ç”º 609', area: 'kyoto' },
          OSAKA_CASTLE: { name: 'å¤§é˜ªåŸå…¬åœ’ (æ£®ä¹‹å®®)', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®å€æ£®ä¹‹å®®ä¸­å¤® 1 ä¸ç›®', area: 'osaka_castle' },
          PARCO: { name: 'å¿ƒé½‹æ©‹ PARCO (ä»»å¤©å ‚)', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®å€å¿ƒé½‹æ©‹ç­‹ 1-8-3', area: 'shinsaibashi' },
          DAIMARU: { name: 'å¤§ä¸¸å¿ƒé½‹æ©‹ (å¯¶å¯å¤¢)', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®å€å¿ƒé½‹æ©‹ç­‹ 1-7-1 æœ¬é¤¨9F', area: 'shinsaibashi' },
          MORINOMIYA: { name: 'æ£®ä¹‹å®®ç«™', address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®å€æ£®ä¹‹å®®ä¸­å¤®1ä¸ç›®', area: 'osaka_castle' }
        };

        const INITIAL_RECOMMENDATIONS = [
          { areaKey: 'namba', areaName: 'é›£æ³¢ / é“é “å €', items: [{ id: 'r1', name: '551 è“¬èŠè‚‰åŒ…', tag: 'ç¾é£Ÿ', desc: 'é«˜å³¶å±‹B1', hours: '10:00-20:00' }, { id: 'r2', name: 'ã‚ã£ã¡ã¡æœ¬èˆ— ç« é­šç‡’', tag: 'ç¾é£Ÿ', desc: 'é“é “å €æ²³é‚Š', hours: '09:00-22:30' }, { id: 'r3', name: 'ç¾æ´¥ã®å¤§é˜ªç‡’', tag: 'ç¾é£Ÿ', desc: 'éœ€æ’éšŠ', hours: '11:00-22:00' }, { id: 'r4', name: 'UHAå‘³è¦ºç³–', tag: 'ä¿å¥', desc: 'å”å‰è¨¶å¾·', hours: '24H' }] },
          { areaKey: 'shinsaibashi', areaName: 'å¿ƒé½‹æ©‹', items: [{ id: 'r5', name: 'S SELECT UVé˜²æ›¬', tag: 'è—¥å¦', desc: 'SUGIé™å®š', hours: '10:00-23:00' }, { id: 'r6', name: 'ä»»å¤©å ‚å•†åº— (PARCO)', tag: 'è³¼ç‰©', desc: '6F', hours: '10:00-20:00' }, { id: 'r7', name: 'å¯¶å¯å¤¢ä¸­å¿ƒ (å¤§ä¸¸)', tag: 'è³¼ç‰©', desc: '9F', hours: '10:00-20:00' }] },
          { areaKey: 'kyoto', areaName: 'äº¬éƒ½ (éŒ¦å¸‚å ´/ç¥‡åœ’)', items: [{ id: 'r8', name: 'ä¸‰æœ¨é›åµ ç‰å­ç‡’', tag: 'ç¾é£Ÿ', desc: 'éŒ¦å¸‚å ´', hours: '09:00-18:00' }, { id: 'r9', name: 'è±†ä¹³ç”œç”œåœˆ', tag: 'ç¾é£Ÿ', desc: 'éŒ¦å¸‚å ´', hours: '10:00-18:00' }, { id: 'r10', name: 'ä¸­æ‘è—¤å‰ (äº¬éƒ½ç«™)', tag: 'ç¾é£Ÿ', desc: 'JRè¥¿å£', hours: '11:00-21:00' }] },
          { areaKey: 'daikoku', areaName: 'æœ¨æ´¥å¸‚å ´ / å¤§åœ‹ç”º', items: [{ id: 'r11', name: 'ä¸¸å‰å£½å¸', tag: 'ç¾é£Ÿ', desc: 'æœ¨æ´¥å¸‚å ´', hours: '05:00-14:00' }, { id: 'r12', name: 'ODA è¶…å¸‚', tag: 'è³¼ç‰©', desc: 'æ‰¹ç™¼åƒ¹', hours: '06:00-18:00' }, { id: 'r13', name: 'ç„¡éµç‚®æ‹‰éºµ', tag: 'ç¾é£Ÿ', desc: 'è¶…æ¿ƒéƒ', hours: '11:00-15:00' }] },
          { areaKey: 'bay', areaName: 'å¤§é˜ªæ¸¯ / å¤©ä¿å±±', items: [{ id: 'r14', name: 'åŒ—æ¥µæ˜Ÿè›‹åŒ…é£¯', tag: 'ç¾é£Ÿ', desc: 'å¤©ä¿å±±', hours: '11:00-21:00' }, { id: 'r15', name: 'æµ·è±¹æŠ±æ•', tag: 'è³¼ç‰©', desc: 'æµ·éŠé¤¨', hours: '10:00-20:00' }] },
          { areaKey: 'airport', areaName: 'é—œè¥¿æ©Ÿå ´', items: [{ id: 'r16', name: 'å‘¼å¸å·§å…‹åŠ›', tag: 'ä¼´æ‰‹ç¦®', desc: 'åŒ—æ–°åœ°', hours: '07:00-23:00' }, { id: 'r17', name: 'LeTao å¤¾å¿ƒé¤…ä¹¾', tag: 'ä¼´æ‰‹ç¦®', desc: 'è‰è“/å·§å…‹åŠ›', hours: '07:00-23:00' }] }
        ];

        const INITIAL_CHECKLIST = [
          { id: 'c1', text: 'è­·ç…§ (æ•ˆæœŸ6å€‹æœˆ)', checked: false }, { id: 'c2', text: 'VJW æˆªåœ– QR Code', checked: false }, { id: 'c3', text: 'ç¶²å¡ / æ¼«éŠé–‹é€š', checked: false }, { id: 'c4', text: 'æ—¥å¹£ç¾é‡‘', checked: false }, { id: 'c5', text: 'ä¿¡ç”¨å¡ (æµ·å¤–å›é¥‹)', checked: false }, { id: 'c6', text: 'å¸¸å‚™è—¥å“', checked: false }, { id: 'c7', text: 'ä½å®¿ç¢ºèªå–® PDF', checked: false }
        ];

        const INITIAL_ITINERARY = [
          {
            dayId: 1, date: '12/25 (å››)', title: 'æŠµé”èˆ‡å®‰é “',
            activities: [
              { id: 'd1-1', time: '10:00', title: 'æŠµé”é—œè¥¿æ©Ÿå ´', type: 'transport', location: LOCATIONS.KIX, note: 'å…¥å¢ƒã€é ˜è¡Œæã€è²· ICOCAã€‚', steps: [{ label: 'å…¥å¢ƒ', detail: 'å¤§å»³æ­æ‰‹æ‰¶æ¢¯ä¸Š 2F' }, { label: 'ç©ºæ©‹', detail: 'å‰å¾€é—œè¥¿æ©Ÿå ´ç«™' }, { label: 'å”®ç¥¨æ©Ÿ', detail: 'è³¼è²· ICOCA', highlight: true }], missions: [{ id: 'm1-1', text: 'è²· ICOCA å¡', type: 'buy' }] },
              { id: 'd1-2', time: '11:30', title: 'Rapi:t ç›´é”é›£æ³¢', type: 'move', location: LOCATIONS.NAMBA_STATION, note: 'æ­ä¹˜è—è‰²æ­¦å£«è™Ÿç›´é”é›£æ³¢ (ç´„38åˆ†)ã€‚', transportMode: 'TRAIN', steps: [{ label: 'æ«ƒå°', detail: 'æ©˜è‰²æ«ƒå°æ›ç¥¨' }, { label: 'é€²ç«™', detail: 'æ·±è—è‰²åˆ—è»Š' }, { label: 'é›£æ³¢', detail: 'çµ‚é»ç«™ä¸‹è»Š' }] },
              { id: 'd1-3', time: '12:30', title: 'é›£æ³¢åˆé¤ & å¯„è¡Œæ', type: 'food', location: LOCATIONS.TAKASHIMAYA, note: 'é«˜å³¶å±‹ç™¾è²¨å¯„æ”¾è¡Œæã€‚åˆé¤æ¨è–¦ 551 è“¬èŠã€‚', missions: [{ id: 'm1-3', text: '551 è“¬èŠè‚‰åŒ…', type: 'eat' }] },
              { id: 'd1-4', time: '15:30', title: 'æ°‘å®¿ Check-in', type: 'stay', location: LOCATIONS.HOME, note: 'å¾é›£æ³¢æ­è¨ˆç¨‹è»Šè‡³å¤§åœ‹ç”ºæ°‘å®¿ã€‚', transportMode: 'TAXI', steps: [{ label: 'è¨ˆç¨‹è»Š', detail: 'å‡ºç¤ºåœ°å€ï¼šæµªé€ŸåŒºæˆæœ¬ç”º 1-5-21', highlight: true }, { label: 'è»Šè³‡', detail: 'ç´„ Â¥1000' }] },
              { id: 'd1-5', time: '17:30', title: 'é»‘é–€å¸‚å ´ & æ—¥æœ¬æ©‹', type: 'sightseeing', location: LOCATIONS.KUROMON, missions: [{ id: 'm1-5', text: 'åƒ æµ·é®®/æ°´æœ', type: 'eat' }] },
              { id: 'd1-6', time: '19:00', title: 'ç„¡éµç‚®æ‹‰éºµ', type: 'food', location: LOCATIONS.MUTEPPO, note: 'è¶…æ¿ƒéƒè±šéª¨ï¼Œæ°‘å®¿æ­¥è¡Œå¯é” (é€±ä¸€ä¼‘)ã€‚', missions: [{ id: 'm1-6', text: 'ç„¡éµç‚®æ‹‰éºµ', type: 'eat' }] }
            ]
          },
          {
            dayId: 2, date: '12/26 (äº”)', title: 'æµ·æ´‹ç”Ÿæ…‹ & ç™¾è¬å¤œæ™¯',
            activities: [
              { id: 'd2-1', time: '08:30', title: 'æœ¨æ´¥å¸‚å ´æ—©é¤', type: 'food', location: LOCATIONS.KIZU_MARKET, missions: [{ id: 'm2-1', text: 'ä¸¸å‰å£½å¸', type: 'eat' }, { id: 'm2-2', text: 'ODA è¶…å¸‚', type: 'buy' }] },
              { id: 'd2-2', time: '11:00', title: 'å¤§é˜ªæµ·éŠé¤¨', type: 'sightseeing', location: LOCATIONS.KAIYUKAN, note: 'å¤§åœ‹ç”º(å¾¡å ‚ç­‹)â†’æœ¬ç”º(ä¸­å¤®ç·š)â†’å¤§é˜ªæ¸¯(1è™Ÿå‡ºå£)ã€‚', officialUrl: 'https://www.kaiyukan.com/' },
              { id: 'd2-3', time: '14:00', title: 'å¤©ä¿å±±æ‘©å¤©è¼ª', type: 'sightseeing', location: LOCATIONS.TEMPOZAN, note: 'åˆé¤æ¨è–¦ï¼šåŒ—æ¥µæ˜Ÿè›‹åŒ…é£¯ (å¤©ä¿å±±åº—)ã€‚' },
              { id: 'd2-4a', time: '18:00', title: 'æ¢…ç”°è—å¤©å¤§å»ˆ', type: 'sightseeing', location: LOCATIONS.UMEDA_SKY, variant: 'A', note: 'æˆ¶å¤–å¼·é¢¨å¤œæ™¯ + ç€§è¦‹å°è·¯æ™šé¤ã€‚', officialUrl: 'https://www.skybldg.co.jp/', missions: [{ id: 'm2-4a', text: 'æ‹ ç©ºä¸­åº­åœ’å¤œæ™¯', type: 'camera' }, { id: 'm2-5a', text: 'åƒ ç€§è¦‹å°è·¯', type: 'eat' }] },
              { id: 'd2-4b', time: '18:00', title: 'é˜¿å€é‡ HARUKAS', type: 'sightseeing', location: LOCATIONS.HARUKAS, variant: 'B', note: 'å®¤å…§ç™¾è¬å¤œæ™¯ + Q\'s Mall è³¼ç‰©ã€‚', officialUrl: 'https://www.abenoharukas-300.jp/', missions: [{ id: 'm2-4b', text: 'æ‹ HARUKAS å¤œæ™¯', type: 'camera' }, { id: 'm2-5b', text: 'é€› Q\'s Mall', type: 'buy' }] }
            ]
          },
          {
            dayId: 3, date: '12/27 (å…­)', title: 'äº¬éƒ½å¤éƒ½ä¸€æ—¥éŠ',
            activities: [
              { id: 'd3-1', time: '09:00', title: 'å‰å¾€äº¬éƒ½ (äº¬é˜ª)', type: 'move', location: LOCATIONS.YASAKA, note: 'å»ç¨‹æ¨è–¦ï¼šå¤§åœ‹ç”ºâ†’æ·€å±‹æ©‹â†’(ç‰¹æ€¥)â†’ç¥‡åœ’å››æ¢ã€‚', steps: [{ label: 'å¾¡å ‚ç­‹ç·š', detail: 'å¤§åœ‹ç”º â†’ æ·€å±‹æ©‹' }, { label: 'äº¬é˜ªé›»è»Š', detail: 'æ·€å±‹æ©‹ â†’ ç¥‡åœ’å››æ¢', highlight: true }, { label: 'æ­¥è¡Œ', detail: 'å¾€å…«å‚ç¥ç¤¾æ–¹å‘' }] },
              { id: 'd3-2', time: '10:30', title: 'å…«å‚ç¥ç¤¾ & ç¥‡åœ’', type: 'sightseeing', location: LOCATIONS.YASAKA, missions: [{ id: 'm3-1', text: 'æ‹ ç¥‡åœ’ç™½å·', type: 'camera' }] },
              { id: 'd3-3', time: '12:30', title: 'åä»£ç‚¸è±¬æ’', type: 'food', location: LOCATIONS.KATSUKURA, note: 'ä¸‰æ¡æœ¬åº—æˆ–å››æ¡åº—ï¼Œè‡ªå·±ç£¨èŠéº»ã€‚' },
              { id: 'd3-4', time: '14:30', title: 'éŒ¦å¸‚å ´æ•£ç­–', type: 'sightseeing', location: LOCATIONS.NISHIKI, note: '17:00 å‰è¦åˆ°ã€‚', missions: [{ id: 'm3-2', text: 'ä¸‰æœ¨é›åµ ç‰å­ç‡’', type: 'eat' }, { id: 'm3-3', text: 'è±†ä¹³ç”œç”œåœˆ', type: 'eat' }] },
              { id: 'd3-5', time: '18:00', title: 'è¿”å›å¤§é˜ª (é˜ªæ€¥)', type: 'move', location: LOCATIONS.HOME, note: 'å›ç¨‹æ¨è–¦ï¼šæ²³åŸç”ºâ†’(é˜ªæ€¥ç‰¹æ€¥)â†’æ¢…ç”°â†’å¤§åœ‹ç”ºã€‚', steps: [{ label: 'é˜ªæ€¥é›»éµ', detail: 'äº¬éƒ½æ²³åŸç”º â†’ å¤§é˜ªæ¢…ç”°', highlight: true }, { label: 'å¾¡å ‚ç­‹ç·š', detail: 'æ¢…ç”° â†’ å¤§åœ‹ç”º' }] }
            ]
          },
          {
            dayId: 4, date: '12/28 (æ—¥)', title: 'å¤§é˜ªåŸ & è³¼ç‰©ç‹‚',
            activities: [
              { id: 'd4-1', time: '09:30', title: 'å‰å¾€æ£®ä¹‹å®®', type: 'move', location: LOCATIONS.OSAKA_CASTLE, alert: 'âš ï¸ å‹™å¿…æ­åˆ°ã€Œæ£®ä¹‹å®®ã€æ‰èƒ½æ­å°ç«è»Šï¼', note: 'å¾¡å ‚ç­‹ç·šæœ¬ç”ºè½‰ä¸­å¤®ç·šã€‚', steps: [{ label: 'åœ°éµ', detail: 'æœ¬ç”ºè½‰ä¸­å¤®ç·š â†’ æ£®ä¹‹å®®' }, { label: 'å°ç«è»Š', detail: 'æ­ä¹˜ Road Train' }] },
              { id: 'd4-2', time: '10:00', title: 'å¤§é˜ªåŸå¤©å®ˆé–£', type: 'sightseeing', location: LOCATIONS.OSAKA_CASTLE, missions: [{ id: 'm4-1', text: 'æ‹ å¤©å®ˆé–£åˆç…§', type: 'camera' }] },
              { id: 'd4-3', time: '13:00', title: 'å¿ƒé½‹æ©‹ PARCO', type: 'buy', location: LOCATIONS.PARCO, note: '6F ä»»å¤©å ‚ / 8F Jump Shopã€‚', missions: [{ id: 'm4-2', text: 'ä»»å¤©å ‚å•†åº— (PARCO)', type: 'buy' }] },
              { id: 'd4-4', time: '14:30', title: 'å¤§ä¸¸å¿ƒé½‹æ©‹', type: 'buy', location: LOCATIONS.DAIMARU, note: 'æœ¬é¤¨ 9F å¯¶å¯å¤¢ä¸­å¿ƒã€‚', missions: [{ id: 'm4-3', text: 'å¯¶å¯å¤¢ä¸­å¿ƒ (å¤§ä¸¸)', type: 'buy' }] },
              { id: 'd4-5', time: '17:30', title: 'é“é “å €æ™šé¤', type: 'food', location: LOCATIONS.GLICO, missions: [{ id: 'm4-4', text: 'ã‚ã£ã¡ã¡æœ¬èˆ— ç« é­šç‡’', type: 'eat' }, { id: 'm4-5', text: 'æ‹ è·‘è·‘äºº', type: 'camera' }] }
            ]
          },
          {
            dayId: 5, date: '12/29 (ä¸€)', title: 'è¿”ç¨‹',
            activities: [
              { id: 'd5-1', time: '07:00', title: 'è¨ˆç¨‹è»Šå»é›£æ³¢', type: 'move', location: LOCATIONS.NAMBA_STATION, note: 'é¿é–‹ä¸Šç­äººæ½®ï¼Œè¡Œæå¤šå¼·çƒˆå»ºè­°æ­è»Šã€‚', transportMode: 'TAXI', steps: [{ label: 'è¨ˆç¨‹è»Š', detail: 'å—æµ·é›£æ³¢ç«™ 3F åŒ—æ”¹æœ­å£', highlight: true }] },
              { id: 'd5-2', time: '07:30', title: 'ç‰¹æ€¥ Rapi:t è¿”ç¨‹', type: 'move', location: LOCATIONS.KIX, note: 'å‰å¾€é—œè¥¿æ©Ÿå ´ T1ã€‚', steps: [{ label: 'å—æµ·é›£æ³¢', detail: '9 è™Ÿæœˆå°æ­ä¹˜' }, { label: 'é—œè¥¿æ©Ÿå ´', detail: 'å¾€ 4F å‡ºå¢ƒå¤§å»³' }] },
              { id: 'd5-3', time: '08:30', title: 'æ©Ÿå ´æœ€å¾Œè¡åˆº', type: 'buy', location: LOCATIONS.KIX, note: 'éå®‰æª¢å¾Œçš„å…ç¨…åº—ã€‚', missions: [{ id: 'm5-1', text: 'å‘¼å¸å·§å…‹åŠ›', type: 'buy' }, { id: 'm5-2', text: 'LeTao å¤¾å¿ƒé¤…ä¹¾', type: 'buy' }] }
            ]
          }
        ];

        const getGoogleMapsLink = (current, prev) => {
          const baseUrl = "https://www.google.com/maps/dir/?api=1&travelmode=transit";
          const dest = encodeURIComponent(`${current.address || current.name}`);
          if (prev && prev.address) {
            const origin = encodeURIComponent(`${prev.address || prev.name}`);
            return `${baseUrl}&origin=${origin}&destination=${dest}`;
          }
          return `${baseUrl}&destination=${dest}`;
        };

        const Card = ({ children, className = '', onClick }) => (
          <div 
            onClick={onClick}
            className={`bg-white rounded-xl border-2 border-[#492540] shadow-[4px_4px_0px_0px_rgba(73,37,64,1)] active:translate-y-[2px] active:shadow-[2px_2px_0px_0px_rgba(73,37,64,1)] transition-all duration-150 overflow-hidden ${className}`}
          >
            {children}
          </div>
        );

        const Badge = ({ icon, name, unlocked }) => (
          <div className={`flex flex-col items-center p-2 rounded-lg border-2 border-[#492540] min-w-[60px] transition-colors duration-300 ${unlocked ? 'bg-[#FFD700] text-[#492540]' : 'bg-gray-200 text-gray-400 grayscale'}`}>
            <span className="text-2xl mb-1 filter drop-shadow-sm">{icon}</span>
            <span className="text-[10px] font-bold text-center leading-tight">{name}</span>
          </div>
        );

        // --- ğŸ“± Main App ---
        function App() {
          const [activeTab, setActiveTab] = useState('QUESTS'); 
          const [currentDay, setCurrentDay] = useState(1);
          const [nightViewChoice, setNightViewChoice] = useState('A'); 
          
          // State Containers
          const [itinerary, setItinerary] = useState(INITIAL_ITINERARY);
          const [completedTasks, setCompletedTasks] = useState([]);
          const [recommendations, setRecommendations] = useState(INITIAL_RECOMMENDATIONS);
          const [checklist, setChecklist] = useState(INITIAL_CHECKLIST);
          const [shoppingList, setShoppingList] = useState([
            { id: 'start-1', name: 'EVE æ­¢ç—›è—¥', count: 1, note: 'ä»£è³¼', checked: false }
          ]);
          const [expenses, setExpenses] = useState([
            { id: 'ex-1', title: 'åˆé¤', amount: 1200, payer: 'åª½åª½' },
            { id: 'ex-2', title: 'é£²æ–™', amount: 150, payer: 'å¼Ÿå¼Ÿ' }
          ]);

          // Auth & Sync State
          const [user, setUser] = useState(null);
          const [isDbLoaded, setIsDbLoaded] = useState(false);
          const [saveStatus, setSaveStatus] = useState('saved'); 
          const [logs, setLogs] = useState([]); // Debug Logs
          
          // Helper: Add Log
          const addLog = (msg) => {
              const time = new Date().toLocaleTimeString();
              setLogs(prev => [`[${time}] ${msg}`, ...prev].slice(0, 50));
          };

          // Sync Feature
          const [tripId, setTripId] = useState('');
          const [showSyncModal, setShowSyncModal] = useState(false);
          const [syncInput, setSyncInput] = useState('');
          
          // Inputs for Modals
          const [newShopItem, setNewShopItem] = useState({ name: '', count: 1, note: '' });
          const [newCheckItem, setNewCheckItem] = useState('');
          const [newExpense, setNewExpense] = useState({ title: '', amount: '', payer: 'åª½åª½' });
          
          // Modals
          const [deleteModal, setDeleteModal] = useState({ show: false, type: null, payload: null });
          const [editModal, setEditModal] = useState({ show: false, dayId: null, activity: null });
          const [addModal, setAddModal] = useState({ show: false, dayId: 1 });
          const [addRecModal, setAddRecModal] = useState({ show: false });
          const [editRecModal, setEditRecModal] = useState({ show: false, areaKey: null, item: null });
          
          // FAB Modals
          const [addShopModal, setAddShopModal] = useState({ show: false });
          const [addCheckModal, setAddCheckModal] = useState({ show: false });
          const [addExpenseModal, setAddExpenseModal] = useState({ show: false });

          // Tools
          const [exchangeRate, setExchangeRate] = useState(0.22);
          const [yenInput, setYenInput] = useState('');
          const [twdOutput, setTwdOutput] = useState(0);
          const [splitTotal, setSplitTotal] = useState('');
          const [splitPeople, setSplitPeople] = useState('');

          // --- ğŸ”¥ Firebase Auth & Sync Logic (Realtime Database) ---
          
          // 1. Auth Initialization
          useEffect(() => {
            if (initError) {
                addLog(`âŒ Firebase åˆå§‹åŒ–å¤±æ•—: ${initError}`);
                return;
            }
            if (!auth) return;
            
            addLog("æ­£åœ¨åˆå§‹åŒ–èº«ä»½é©—è­‰...");
            const initAuth = async () => {
              try {
                  await signInAnonymously(auth);
                  addLog("âœ… åŒ¿åç™»å…¥æˆåŠŸ");
              } catch (e) {
                  addLog(`âŒ ç™»å…¥å¤±æ•—: ${e.message}`);
              }
            };
            initAuth();
            
            const unsubscribe = onAuthStateChanged(auth, (u) => { 
                if (u) {
                    setUser(u);
                    addLog(`ğŸ‘¤ ç”¨æˆ¶å·²å°±ç·’: ${u.uid.slice(0,5)}...`);
                } else {
                    addLog("âš ï¸ ç”¨æˆ¶å·²ç™»å‡º");
                }
            });
            return () => unsubscribe();
          }, []);

          // 2. Realtime Listener (onValue)
          useEffect(() => {
            if (!user || !db) return;

            addLog(`ğŸ“¡ é–‹å§‹ç›£è½è³‡æ–™åº«... TripID: ${tripId || 'Private'}`);

            // å®šç¾©è³‡æ–™èˆ‡è·¯å¾‘çš„å°æ‡‰
            const dataKeys = [
                { key: 'itinerary', setter: setItinerary, initial: INITIAL_ITINERARY },
                { key: 'shopping', setter: setShoppingList, initial: shoppingList },
                { key: 'recommendations', setter: setRecommendations, initial: INITIAL_RECOMMENDATIONS },
                { key: 'checklist', setter: setChecklist, initial: INITIAL_CHECKLIST },
                { key: 'expenses', setter: setExpenses, initial: expenses },
                { key: 'completedTasks', setter: setCompletedTasks, initial: [] }
            ];

            const unsubscribers = dataKeys.map(({ key, setter, initial }) => {
                let dbRef;
                // è·¯å¾‘é‚è¼¯ï¼šæœ‰ TripID å‰‡èµ°å…±äº«è·¯å¾‘ï¼Œå¦å‰‡èµ°ç§æœ‰è·¯å¾‘
                if (tripId) {
                    dbRef = ref(db, `trips/${tripId}/${key}`);
                } else {
                    dbRef = ref(db, `users/${user.uid}/storage/${key}`);
                }

                return onValue(dbRef, (snapshot) => {
                    const val = snapshot.val();
                    if (val) {
                        setter(val);
                        // ç‚ºäº†é¿å…æ´—ç‰ˆï¼Œåªåœ¨ç¬¬ä¸€æ¬¡æˆ–éå¯«å…¥æ™‚ Log (é€™è£¡ç°¡å–®åš)
                        // addLog(`ğŸ“¥ æ”¶åˆ° ${key} æ›´æ–°`); 
                    }
                    setIsDbLoaded(true);
                }, (error) => {
                    addLog(`âŒ è®€å–å¤±æ•— (${key}): ${error.message}`);
                    if (error.code === 'PERMISSION_DENIED') {
                        addLog("â›” æ¬Šé™ä¸è¶³ï¼è«‹æª¢æŸ¥ Firebase Console çš„ Rules è¨­å®šã€‚");
                    }
                });
            });

            return () => unsubscribers.forEach(unsub => unsub());
          }, [user, tripId]); // ç•¶ä½¿ç”¨è€…æˆ– TripID æ”¹è®Šæ™‚é‡æ–°è¨‚é–±

          // 3. Auto-Save Logic (å¯«å…¥è³‡æ–™åº«)
          const saveToDb = async (key, data) => {
            if (user && isDbLoaded && db) {
              setSaveStatus('saving');
              try {
                let dbRef;
                if (tripId) {
                    dbRef = ref(db, `trips/${tripId}/${key}`);
                } else {
                    dbRef = ref(db, `users/${user.uid}/storage/${key}`);
                }
                await set(dbRef, data);
                // addLog(`ğŸ“¤ å¯«å…¥æˆåŠŸ: ${key}`);
                setTimeout(() => setSaveStatus('saved'), 500);
              } catch (e) {
                console.error("Save error:", e);
                addLog(`âŒ å¯«å…¥å¤±æ•— (${key}): ${e.message}`);
                setSaveStatus('error');
              }
            }
          };

          // ç›£è½ State è®ŠåŒ–ä¸¦å¯«å…¥ DB
          useEffect(() => { if(isDbLoaded) saveToDb('itinerary', itinerary) }, [itinerary, isDbLoaded, tripId]);
          useEffect(() => { if(isDbLoaded) saveToDb('shopping', shoppingList) }, [shoppingList, isDbLoaded, tripId]);
          useEffect(() => { if(isDbLoaded) saveToDb('recommendations', recommendations) }, [recommendations, isDbLoaded, tripId]);
          useEffect(() => { if(isDbLoaded) saveToDb('checklist', checklist) }, [checklist, isDbLoaded, tripId]);
          useEffect(() => { if(isDbLoaded) saveToDb('expenses', expenses) }, [expenses, isDbLoaded, tripId]);
          useEffect(() => { if(isDbLoaded) saveToDb('completedTasks', completedTasks) }, [completedTasks, isDbLoaded, tripId]);

          useEffect(() => {
            const yen = parseFloat(yenInput) || 0;
            setTwdOutput(Math.ceil(yen * exchangeRate));
          }, [yenInput, exchangeRate]);

          // --- Sync Handlers ---
          const handleJoinTrip = () => {
            if (syncInput.trim()) {
              const code = syncInput.trim().toUpperCase();
              
              // è©¢å•æ˜¯å¦è¦è¦†è“‹æœ¬åœ°è³‡æ–™ï¼ˆå¦‚æœæ˜¯å‰›å»ºç«‹çš„ï¼‰
              if (confirm(`åŠ å…¥æ—…ç¨‹ã€Œ${code}ã€ï¼Ÿ\næ³¨æ„ï¼šé€™å°‡æœƒåˆ‡æ›åˆ°å…±äº«è³‡æ–™åº«ã€‚`)) {
                  setTripId(code);
                  localStorage.setItem('osaka_trip_id', code);
                  setShowSyncModal(false);
                  setIsDbLoaded(false); // é‡ç½®è¼‰å…¥ç‹€æ…‹ä»¥è§¸ç™¼æ–°è·¯å¾‘çš„ç›£è½
                  addLog(`ğŸ”„ åˆ‡æ›è‡³æ—…ç¨‹: ${code}`);
              }
            }
          };

          const handleLeaveTrip = () => {
            if (window.confirm("ç¢ºå®šè¦é€€å‡ºåŒæ­¥æ¨¡å¼å—ï¼Ÿæ‚¨å°‡å›åˆ°è‡ªå·±çš„ç§äººè¡Œç¨‹ã€‚")) {
              setTripId('');
              localStorage.removeItem('osaka_trip_id');
              setShowSyncModal(false);
              setIsDbLoaded(false);
              addLog("ğŸ‘‹ é€€å‡ºåŒæ­¥ï¼Œå›åˆ°ç§äººæ¨¡å¼");
            }
          };

          // --- CRUD Handlers ---
          const handleConfirmDelete = () => {
            const { type, payload } = deleteModal;
            if (type === 'ACTIVITY') {
                const { dayId, actId } = payload;
                setItinerary(prev => prev.map(day => {
                    if (day.dayId === dayId) {
                        return { ...day, activities: day.activities.filter(a => a.id !== actId) };
                    }
                    return day;
                }));
            } else if (type === 'REC_ITEM') {
                const { areaKey, itemId } = payload;
                setRecommendations(prev => prev.map(area => {
                    if (area.areaKey === areaKey) {
                        return { ...area, items: area.items.filter(i => i.id !== itemId) };
                    }
                    return area;
                }));
            } else if (type === 'SHOP_ITEM') {
                const { itemId } = payload;
                setShoppingList(prev => prev.filter(i => i.id !== itemId));
            } else if (type === 'CHECK_ITEM') {
                const { itemId } = payload;
                setChecklist(prev => prev.filter(i => i.id !== itemId));
            } else if (type === 'EXPENSE_ITEM') {
                const { itemId } = payload;
                setExpenses(prev => prev.filter(e => e.id !== itemId));
            }
            setDeleteModal({ show: false, type: null, payload: null });
          };

          // Itinerary
          const handleSaveEdit = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newTitle = formData.get('title');
            const newTime = formData.get('time');
            const newNote = formData.get('note');
            setItinerary(prev => prev.map(day => {
              if (day.dayId === editModal.dayId) {
                return {
                  ...day,
                  activities: day.activities.map(act => 
                    act.id === editModal.activity.id ? { ...act, title: newTitle, time: newTime, note: newNote } : act
                  )
                };
              }
              return day;
            }));
            setEditModal({ show: false, dayId: null, activity: null });
          };

          const handleAddActivity = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newTitle = formData.get('title');
            const newTime = formData.get('time');
            const newAddress = formData.get('address');
            setItinerary(prev => prev.map(day => {
              if (day.dayId === addModal.dayId) {
                return {
                  ...day,
                  activities: [...day.activities, {
                    id: `new-${Date.now()}`, time: newTime, title: newTitle, type: 'sightseeing', location: { name: newTitle, address: newAddress }, note: 'æ–°å¢çš„è¡Œç¨‹', missions: []
                  }].sort((a, b) => a.time.localeCompare(b.time))
                };
              }
              return day;
            }));
            setAddModal({ show: false, dayId: 1 });
          };

          // Recommendations
          const handleAddRec = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const name = formData.get('name');
            const areaKey = formData.get('areaKey');
            const tag = formData.get('tag');
            const desc = formData.get('desc');
            const hours = formData.get('hours');
            setRecommendations(prev => prev.map(area => {
              if (area.areaKey === areaKey) {
                return { ...area, items: [...area.items, { id: `cr-${Date.now()}`, name, tag, desc, hours }] };
              }
              return area;
            }));
            setAddRecModal({ show: false });
          };

          const handleDeleteRec = (areaKey, itemId, e) => {
            e.stopPropagation(); 
            setDeleteModal({ show: true, type: 'REC_ITEM', payload: { areaKey, itemId } });
          };

          const handleSaveRecEdit = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const name = formData.get('name');
            const tag = formData.get('tag');
            const desc = formData.get('desc');
            const hours = formData.get('hours');
            const areaKey = editRecModal.areaKey;
            setRecommendations(prev => prev.map(area => {
              if (area.areaKey === areaKey) {
                return {
                   ...area,
                   items: area.items.map(item => 
                     item.id === editRecModal.item.id ? { ...item, name, tag, desc, hours } : item
                   )
                };
              }
              return area;
            }));
            setEditRecModal({ show: false, areaKey: null, item: null });
          };

          const handleAddMissionFromRec = (dayId, activityId, recItem) => {
            setItinerary(prev => prev.map(day => {
              if (day.dayId === dayId) {
                return {
                  ...day,
                  activities: day.activities.map(act => {
                    if (act.id === activityId) {
                      if (act.missions && act.missions.some(m => m.text === recItem.name)) return act;
                      const newMission = { id: `m-${Date.now()}`, text: recItem.name, type: recItem.tag === 'ç¾é£Ÿ' ? 'eat' : 'buy' };
                      return { ...act, missions: [...(act.missions || []), newMission] };
                    }
                    return act;
                  })
                };
              }
              return day;
            }));
          };

          // Shopping & Checklist
          const updateShoppingItem = (id, field, value) => {
            setShoppingList(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
          };
          const incrementItem = (id, delta) => {
            setShoppingList(prev => prev.map(item => {
              if (item.id === id) {
                const newCount = Math.max(1, (item.count || 1) + delta);
                return { ...item, count: newCount };
              }
              return item;
            }));
          };
          const addToShoppingList = (item) => {
            setShoppingList(prev => {
                const exists = prev.find(i => i.name === item.name);
                if (exists) { alert(`${item.name} å·²ç¶“åœ¨æ¸…å–®ä¸­äº†ï¼`); return prev; }
                return [...prev, { id: `rec-${Date.now()}`, name: item.name, checked: false, note: item.desc || '', count: 1 }];
            });
          };
          
          const handleAddNewShoppingItem = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const name = formData.get('name');
            const count = formData.get('count');
            const note = formData.get('note');
            if (!name) return;
            setShoppingList(prev => [...prev, { id: `m-${Date.now()}`, name, count: parseInt(count) || 1, note, checked: false }]);
            setAddShopModal({ show: false });
          };
          
          const handleAddExpense = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const title = formData.get('title');
            const amount = parseInt(formData.get('amount'));
            const payer = formData.get('payer');
            if (title && amount) {
                setExpenses(prev => [...prev, { id: `ex-${Date.now()}`, title, amount, payer }]);
                setAddExpenseModal({ show: false });
            }
          };
          const deleteExpense = (id) => { setExpenses(prev => prev.filter(e => e.id !== id)); };
          const totalExpense = expenses.reduce((sum, item) => sum + item.amount, 0);

          const toggleChecklist = (id) => { setChecklist(prev => prev.map(item => item.id === id ? { ...item, checked: !item.checked } : item)); };
          
          const addChecklistItem = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const text = formData.get('text');
            if (!text) return;
            setChecklist(prev => [...prev, { id: `c-${Date.now()}`, text, checked: false }]);
            setAddCheckModal({ show: false });
          };

          const deleteChecklistItem = (id) => { setChecklist(prev => prev.filter(i => i.id !== id)); };
          const toggleTask = (taskId) => { setCompletedTasks(prev => prev.includes(taskId) ? prev.filter(id => id !== taskId) : [...prev, taskId]); };

          const badges = [ { id: 'b1', name: 'ç« é­šç‡’é”äºº', icon: 'ğŸ™', check: t => t.some(id => itinerary.some(d => d.activities.some(a => a.missions?.some(m => m.id === id && m.text.includes('ç« é­šç‡’'))))) }, { id: 'b2', name: 'å¤œæ™¯æ”¶è—å®¶', icon: 'ğŸŒƒ', check: t => t.includes('m2-4a') || t.includes('m2-4b') }, { id: 'b3', name: 'è³¼ç‰©ç‹‚', icon: 'ğŸ›ï¸', check: t => t.length >= 5 }, { id: 'b4', name: 'å¤éƒ½å·¡ç¦®', icon: 'â›©ï¸', check: t => t.includes('m3-1') } ];
          const unlockedBadges = useMemo(() => badges.filter(b => b.check(completedTasks)), [completedTasks]);
          const dayData = itinerary.find(d => d.dayId === currentDay);
          const filteredActivities = dayData?.activities.filter(a => !a.variant || a.variant === nightViewChoice);
          const getAreaRecommendations = (locationArea) => { if (!locationArea) return []; const rec = recommendations.find(r => r.areaKey === locationArea); return rec ? rec.items : []; };

          if (initError) {
            return (
                <div className="fixed inset-0 bg-[#f6ea8c] flex flex-col items-center justify-center text-[#492540] p-8 text-center">
                    <h2 className="font-black text-xl mb-4 text-[#c03546]">è¨­å®šéŒ¯èª¤</h2>
                    <p className="font-bold mb-4">{initError}</p>
                    <p>è«‹æª¢æŸ¥ç¨‹å¼ç¢¼ä¸­çš„ Firebase Config è¨­å®šã€‚</p>
                </div>
            );
          }

          if (!isDbLoaded && user) {
            return (
              <div className="fixed inset-0 bg-[#f6ea8c] flex flex-col items-center justify-center text-[#492540]">
                <div className="animate-spin mb-4"><Loader size={40} /></div>
                <h2 className="font-black text-xl">æ­£åœ¨åŒæ­¥æ‚¨çš„é›²ç«¯å†’éšªç´€éŒ„...</h2>
                <div className="debug-console mt-4 w-full max-w-sm text-left">
                    {logs.map((log, i) => <div key={i}>{log}</div>)}
                </div>
              </div>
            );
          }

          return (
            <div className="fixed inset-0 flex flex-col bg-[#f6ea8c] text-[#492540] font-sans max-w-md mx-auto overflow-hidden">
              {/* Header */}
              <header className="flex-none bg-white border-b-2 border-[#492540] p-4 pt-safe-top z-50 shadow-md">
                <div className="flex justify-between items-center mb-2">
                  <div>
                    <h1 className="text-xl font-black tracking-tighter text-[#c03546]">OSAKA 2025</h1>
                    <div className="flex items-center gap-3">
                       <p className="text-[10px] font-bold tracking-widest bg-[#492540] text-white px-2 py-0.5 rounded-full inline-block">LEVEL: ADVENTURER</p>
                       <div className="flex items-center gap-1 text-[10px] font-bold">
                         {saveStatus === 'saving' ? <span className="text-orange-500 flex items-center gap-1 animate-pulse"><Loader size={10}/> åŒæ­¥ä¸­...</span> : <span className="text-[#00A3E0] flex items-center gap-1"><Check size={10}/> å·²å„²å­˜</span>}
                       </div>
                    </div>
                  </div>
                  <div className="flex flex-col items-end gap-1">
                    <button onClick={() => setShowSyncModal(true)} className={`text-white px-3 py-1 rounded-full border-2 border-[#492540] shadow-sm text-xs font-bold flex items-center gap-1 active:translate-y-1 ${tripId ? 'bg-[#c03546]' : 'bg-[#492540]'}`}>
                       {tripId ? <Users size={14}/> : <Cloud size={14}/>} 
                       {tripId ? 'å·²åŒæ­¥' : 'åŒæ­¥è¨­å®š'}
                    </button>
                    <a href="https://tenki.jp/forecast/6/30/6200/27100/" target="_blank" rel="noreferrer" className="bg-[#00A3E0] text-white px-3 py-1 rounded-full border-2 border-[#492540] shadow-sm text-xs font-bold flex items-center gap-1 active:translate-y-1">
                      <CloudSun size={14} /> å¤©æ°£
                    </a>
                  </div>
                </div>
                <div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                  {badges.map(b => <Badge key={b.id} {...b} unlocked={unlockedBadges.some(ub => ub.id === b.id)} />)}
                </div>
              </header>

              {/* Main Content */}
              <main className="flex-1 overflow-y-auto relative overscroll-contain">
                <div className="p-4 pb-48 space-y-4 min-h-full">
                  {activeTab === 'QUESTS' && dayData && (
                    <>
                      <div className="flex items-center justify-between bg-white p-2 rounded-xl border-2 border-[#492540] shadow-sm mb-4">
                        <button onClick={()=>setCurrentDay(d=>Math.max(1,d-1))} className="p-2 active:scale-90 text-[#492540]"><ChevronDown className="rotate-90"/></button>
                        <div className="font-black text-xl text-[#c03546]">Day {currentDay}</div>
                        <button onClick={()=>setCurrentDay(d=>Math.min(5,d+1))} className="p-2 active:scale-90 text-[#492540]"><ChevronDown className="-rotate-90"/></button>
                      </div>
                      <div className="mb-4">
                        <h2 className="text-2xl font-black">{dayData.date}</h2>
                        <h3 className="text-lg font-bold text-[#f26d5b]">{dayData.title}</h3>
                        {currentDay === 2 && (
                          <div className="mt-3 flex bg-white rounded-lg border-2 border-[#492540] p-1 shadow-sm">
                            <button onClick={() => setNightViewChoice('A')} className={`flex-1 py-1 text-xs font-bold rounded transition-colors ${nightViewChoice === 'A' ? 'bg-[#c03546] text-white' : 'text-gray-400'}`}>A: æ¢…ç”° (æˆ¶å¤–)</button>
                            <button onClick={() => setNightViewChoice('B')} className={`flex-1 py-1 text-xs font-bold rounded transition-colors ${nightViewChoice === 'B' ? 'bg-[#00A3E0] text-white' : 'text-gray-400'}`}>B: é˜¿å€é‡ (å®¤å…§)</button>
                          </div>
                        )}
                      </div>
                      <div className="space-y-6 relative ml-4 border-l-4 border-dotted border-[#c03546]/30 pl-6 pb-10">
                        {filteredActivities.map((act, idx) => {
                          const prevAct = idx > 0 ? filteredActivities[idx - 1] : null;
                          const prevLoc = prevAct ? prevAct.location : null;
                          const navLink = getGoogleMapsLink(act.location, prevLoc);
                          const areaRecs = getAreaRecommendations(act.location.area);
                          return (
                            <div key={act.id} className="relative group">
                              <div className="absolute -left-[39px] top-0 bg-[#f6ea8c] border-2 border-[#492540] rounded-full w-8 h-8 flex items-center justify-center text-[10px] font-bold z-10 shadow-sm">{act.time}</div>
                              <Card className="p-3">
                                <div className="flex justify-between items-start mb-2">
                                  <div className="pr-2">
                                    <h4 className="font-black text-lg leading-tight text-[#492540]">{act.title}</h4>
                                    <div className="text-xs text-gray-500 font-bold mt-1 flex items-center gap-1"><MapPin size={12} /> {act.location.name}</div>
                                  </div>
                                  <div className="flex gap-2 shrink-0">
                                    <button onClick={() => setEditModal({ show: true, dayId: currentDay, activity: act })} className="text-gray-400 hover:text-[#00A3E0]"><Edit2 size={18} /></button>
                                    <button onClick={() => setDeleteModal({ show: true, type: 'ACTIVITY', payload: { dayId: currentDay, actId: act.id } })} className="text-gray-400 hover:text-[#c03546]"><Trash2 size={18} /></button>
                                  </div>
                                </div>
                                <div className="flex gap-2 mb-3">
                                  <a href={navLink} target="_blank" rel="noreferrer" className="flex-1 bg-[#492540] text-white text-xs font-bold py-1.5 px-3 rounded flex items-center justify-center gap-1 active:scale-95 transition-transform shadow-[2px_2px_0px_0px_rgba(0,0,0,0.2)]">
                                    <Navigation size={14} /> å°èˆªå‰å¾€
                                  </a>
                                </div>
                                {areaRecs.length > 0 && (
                                  <div className="mb-3">
                                      <div className="text-[10px] font-bold text-gray-400 mb-1 flex items-center gap-1"><LinkIcon size={10} /> å€åŸŸæ¨è–¦ ({recommendations.find(r=>r.areaKey===act.location.area)?.areaName})ï¼š</div>
                                      <div className="flex flex-wrap gap-1">
                                          {areaRecs.map((rec, rIdx) => (
                                              <button key={rIdx} onClick={() => handleAddMissionFromRec(currentDay, act.id, rec)} className="bg-white border border-[#f26d5b] text-[#f26d5b] text-[10px] px-2 py-0.5 rounded-full font-bold hover:bg-[#f26d5b] hover:text-white transition-colors flex items-center gap-1">
                                                  <Plus size={8} /> {rec.name}
                                              </button>
                                          ))}
                                      </div>
                                  </div>
                                )}
                                {act.steps && (
                                  <div className="bg-gray-50 rounded-lg p-2 mb-3 border border-gray-200">
                                    <div className="flex items-center gap-2 mb-2 text-xs font-black text-[#c03546] uppercase tracking-wide">
                                      {act.transportMode === 'TAXI' ? <Car size={14}/> : <Train size={14}/>} äº¤é€šç§»å‹•
                                    </div>
                                    {act.steps.map((step, sIdx) => (
                                      <div key={sIdx} className="flex gap-3 mb-1 last:mb-0 relative z-0">
                                        <div className="flex flex-col items-center w-4 pt-1"><div className="w-2 h-2 rounded-full bg-[#c03546]" />{sIdx !== act.steps.length - 1 && <div className="w-0.5 h-full bg-gray-300 -mb-1" />}</div>
                                        <div className="text-sm"><span className="font-bold text-[#492540]">{step.label}</span><span className={`ml-2 text-gray-600 ${step.highlight ? 'bg-[#f6ea8c] px-1 rounded font-bold' : ''}`}>{step.detail}</span></div>
                                      </div>
                                    ))}
                                  </div>
                                )}
                                {act.alert && <div className="text-xs font-bold text-red-600 bg-red-50 p-2 rounded mb-2 border border-red-100 flex items-center gap-1"><AlertTriangle size={14}/> {act.alert}</div>}
                                {act.note && <div className="text-sm text-gray-700 bg-[#fffbeb] p-2 rounded border border-[#fef3c7] mb-2">ğŸ’¡ {act.note}</div>}
                                {act.missions && act.missions.length > 0 && (
                                  <div className="mt-3 space-y-1">
                                    {act.missions.map(m => (
                                      <div key={m.id} onClick={() => toggleTask(m.id)} className={`flex items-center justify-between p-2 rounded border-2 cursor-pointer transition-all ${completedTasks.includes(m.id) ? 'bg-[#f26d5b] border-[#f26d5b] text-white shadow-none translate-y-1' : 'bg-white border-dashed border-gray-300 text-gray-500 hover:bg-gray-50'}`}>
                                        <span className="text-sm font-bold flex items-center gap-2">
                                          {m.type === 'camera' && <Camera size={14}/>}{m.type === 'buy' && <ShoppingBag size={14}/>}{m.type === 'eat' && <Coffee size={14}/>}{m.text}
                                        </span>
                                        {completedTasks.includes(m.id) ? <CheckCircle size={16} className="text-white fill-current"/> : <Circle size={16}/>}
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </Card>
                            </div>
                          );
                        })}
                        <button onClick={() => setAddModal({ show: true, dayId: currentDay })} className="w-full py-3 border-2 border-dashed border-[#492540] rounded-xl text-gray-400 font-bold hover:bg-white/50 transition-colors flex items-center justify-center gap-2 active:scale-95"><Plus size={20} /> æ–°å¢è¡Œç¨‹</button>
                      </div>
                    </>
                  )}

                  {/* ... (ITEMS, SHOPPING, GEAR, TOOLS sections are same as previous, just ensure they are inside main div) */}
                  {activeTab === 'ITEMS' && (
                    <div className="space-y-4">
                      {/* ... (Recommendations UI) ... */}
                      <div className="bg-[#c03546] text-white p-4 rounded-xl border-2 border-[#492540] shadow-[4px_4px_0px_0px_rgba(73,37,64,1)]">
                        <h2 className="font-black text-xl flex items-center gap-2"><Star className="fill-current text-[#FFD700]" /> å¿…åƒå¿…è²·æƒ…å ±</h2>
                        <p className="text-xs opacity-90 mt-1">ä¾†è‡ªç¶²è·¯æ¨è–¦ â€¢ é»æ“Š + åŠ å…¥å€‹äººæ¸…å–®</p>
                      </div>
                      {recommendations.map((area, idx) => (
                        <div key={idx} className="bg-white rounded-xl border-2 border-[#492540] overflow-hidden shadow-sm">
                          <div className="bg-gray-100 p-3 font-black border-b-2 border-[#492540] flex items-center gap-2 text-[#492540]"><MapPin size={16} className="text-[#c03546]" /> {area.areaName}</div>
                          <div className="divide-y divide-gray-200">
                            {area.items.map((item, iIdx) => (
                              <div key={iIdx} className="p-3 hover:bg-[#fffdf5] group relative">
                                <div className="flex justify-between items-start">
                                  <div>
                                      <div className="flex items-center gap-2 flex-wrap">
                                        <span className="font-bold text-[#492540]">{item.name}</span>
                                        <span className={`text-[10px] px-1.5 py-0.5 rounded text-white font-bold ${item.tag === 'ç¾é£Ÿ' ? 'bg-[#f26d5b]' : 'bg-[#00A3E0]'}`}>{item.tag}</span>
                                      </div>
                                      <p className="text-xs text-gray-500 mt-1">{item.desc}</p>
                                      {item.hours && <p className="text-[10px] text-gray-400 mt-0.5">ğŸ•’ {item.hours}</p>}
                                  </div>
                                  <div className="flex gap-2">
                                      <button onClick={() => setEditRecModal({ show: true, areaKey: area.areaKey, item: item })} className="text-gray-300 hover:text-[#00A3E0] p-1"><Edit2 size={16} /></button>
                                      <button onClick={(e) => { e.stopPropagation(); setDeleteModal({ show: true, type: 'REC_ITEM', payload: { areaKey: area.areaKey, itemId: item.id } }); }} className="text-gray-300 hover:text-red-500 p-1"><Trash2 size={16} /></button>
                                      <button onClick={() => addToShoppingList(item)} className="bg-[#492540] text-white p-1.5 rounded-lg active:scale-90 shadow-[2px_2px_0px_0px_rgba(0,0,0,0.2)] ml-2"><Plus size={16} /></button>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      ))}
                      <button onClick={() => setAddRecModal({ show: true })} className="w-full py-3 bg-[#f26d5b] text-white rounded-xl font-bold border-2 border-[#492540] shadow-[2px_2px_0px_0px_#492540] active:translate-y-1 active:shadow-none">+ æ–°å¢æ¨è–¦é …ç›®</button>
                    </div>
                  )}

                  {activeTab === 'SHOPPING' && (
                    <div className="flex flex-col h-full">
                       <div className="flex justify-between items-end mb-4 flex-none">
                         <h2 className="font-black text-2xl text-[#492540]">æˆ‘çš„è³¼ç‰©è»Š</h2>
                         <button onClick={() => { const text = shoppingList.map(i => `- [${i.checked?'x':' '}] ${i.name} (x${i.count}) ${i.note ? `| ${i.note}` : ''}`).join('\n'); navigator.clipboard.writeText(text); alert('æ¸…å–®å·²è¤‡è£½ï¼'); }} className="text-xs font-bold flex items-center gap-1 bg-white border-2 border-[#492540] px-2 py-1 rounded shadow-sm active:translate-y-1"><Copy size={12}/> è¤‡è£½</button>
                       </div>
                       <Card className="flex flex-col flex-1 overflow-hidden">
                          <div className="flex-1 overflow-y-auto">
                            {shoppingList.length === 0 ? <div className="h-full flex flex-col items-center justify-center text-gray-400 p-8"><ShoppingBag size={48} className="mb-2 opacity-20"/><p>æ¸…å–®æ˜¯ç©ºçš„</p></div> : (
                              <div className="divide-y divide-gray-100">
                                {shoppingList.map(item => (
                                  <div key={item.id} className="p-3 hover:bg-gray-50">
                                     <div className="flex items-center gap-3 mb-2">
                                         <button onClick={() => updateShoppingItem(item.id, 'checked', !item.checked)}>{item.checked ? <CheckCircle className="text-[#f26d5b] fill-current text-white w-6 h-6"/> : <Circle className="text-gray-300 w-6 h-6"/>}</button>
                                         <div className={`flex-1 font-bold text-lg ${item.checked ? 'line-through text-gray-400' : 'text-[#492540]'}`}>{item.name}</div>
                                         <button onClick={() => setDeleteModal({ show: true, type: 'SHOP_ITEM', payload: { itemId: item.id } })} className="text-gray-300 hover:text-red-500"><Trash2 size={16}/></button>
                                     </div>
                                     <div className="flex gap-2 pl-9">
                                         <div className="flex items-center border-2 border-gray-300 rounded bg-white">
                                             <button onClick={() => incrementItem(item.id, -1)} className="px-2 py-1 text-black font-bold hover:bg-gray-100"><Minus size={14}/></button>
                                             <span className="text-sm font-black px-2 w-8 text-center text-black border-x-2 border-gray-100">{item.count || 1}</span>
                                             <button onClick={() => incrementItem(item.id, 1)} className="px-2 py-1 text-black font-bold hover:bg-gray-100"><Plus size={14}/></button>
                                         </div>
                                         <div className="flex-1 flex items-center gap-2 bg-white border-2 border-gray-300 rounded px-2">
                                             <FileText size={14} className="text-gray-400 shrink-0"/>
                                             <input type="text" placeholder="å‚™è¨»..." className="bg-transparent text-sm w-full py-1 focus:outline-none text-black font-bold" value={item.note || ''} onChange={(e) => updateShoppingItem(item.id, 'note', e.target.value)}/>
                                         </div>
                                     </div>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                       </Card>
                    </div>
                  )}

                  {activeTab === 'GEAR' && (
                     <div className="flex flex-col h-full">
                       <Card className="flex flex-col h-full p-4">
                        <h2 className="font-black text-xl mb-4 text-[#c03546] flex items-center gap-2 flex-none"><Briefcase /> è¡Œå‰æª¢æŸ¥ (Checklist)</h2>
                        <div className="space-y-2 mb-4 flex-1 overflow-y-auto">
                          {checklist.map((item) => (
                            <div key={item.id} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-white transition-colors">
                              <button onClick={() => toggleChecklist(item.id)}>{item.checked ? <CheckCircle className="text-[#f26d5b] fill-current text-white w-5 h-5"/> : <Circle className="text-gray-300 w-5 h-5"/>}</button>
                              <span className={`font-bold text-gray-700 flex-1 ${item.checked ? 'line-through opacity-50' : ''}`}>{item.text}</span>
                              <button onClick={() => setDeleteModal({ show: true, type: 'CHECK_ITEM', payload: { itemId: item.id } })} className="text-gray-300 hover:text-red-500"><Trash2 size={16}/></button>
                            </div>
                          ))}
                        </div>
                       </Card>
                     </div>
                  )}

                  {activeTab === 'TOOLS' && (
                    <div className="space-y-4">
                       <Card className="p-0 overflow-hidden">
                          <div className="bg-[#492540] p-3 text-white font-bold flex items-center gap-2"><DollarSign size={18}/> å³æ™‚åŒ¯ç‡è©¦ç®—</div>
                          <div className="p-4 bg-white">
                              <div className="flex items-center gap-2 mb-4 bg-yellow-50 p-2 rounded border border-yellow-200">
                                <span className="text-sm font-bold text-[#492540]">ç›®å‰åŒ¯ç‡:</span>
                                <input type="number" value={exchangeRate} onChange={e=>setExchangeRate(e.target.value)} className="w-20 bg-white border-2 border-[#492540] rounded px-2 py-1 text-center font-bold text-black"/>
                              </div>
                              <div className="flex items-center gap-3">
                                 <div className="flex-1">
                                    <label className="text-xs font-bold text-gray-500 block mb-1">æ—¥å¹£ (JPY)</label>
                                    <input type="number" value={yenInput} placeholder="0" className="w-full p-2 border-2 border-gray-300 rounded bg-white text-black font-black text-xl font-mono" onChange={e => setYenInput(e.target.value)}/>
                                 </div>
                                 <ArrowRight className="mt-5 text-[#492540]"/>
                                 <div className="flex-1">
                                    <label className="text-xs font-bold text-gray-500 block mb-1">å°å¹£ (TWD)</label>
                                    <div className="w-full p-2 border-2 border-gray-300 rounded bg-gray-100 text-[#492540] font-black text-xl font-mono min-h-[46px] flex items-center">{twdOutput}</div>
                                 </div>
                              </div>
                          </div>
                       </Card>
                       <Card className="p-0 overflow-hidden">
                         <div className="bg-[#00A3E0] p-3 text-white font-bold flex items-center gap-2"><Wallet size={18}/> æ—…è¡Œè¨˜å¸³æœ¬</div>
                         <div className="p-4 bg-white">
                             <div className="bg-gray-100 rounded-lg p-3 mb-4 max-h-40 overflow-y-auto border-2 border-gray-200">
                                 {expenses.length === 0 ? <p className="text-xs text-gray-400 text-center py-4">å°šç„¡æ¶ˆè²»ç´€éŒ„</p> : 
                                  expenses.map(ex => (
                                      <div key={ex.id} className="flex justify-between items-center mb-2 last:mb-0 border-b border-gray-200 pb-1">
                                          <div className="flex items-center gap-2">
                                            <span className="text-sm font-bold text-[#492540]">{ex.title}</span>
                                            <span className="text-[10px] bg-gray-200 text-gray-600 px-1.5 rounded flex items-center gap-1"><UserCircle size={10}/> {ex.payer}</span>
                                          </div>
                                          <div className="flex items-center gap-2"><span className="text-sm font-mono font-bold">Â¥{ex.amount}</span><button onClick={() => setDeleteModal({ show: true, type: 'EXPENSE_ITEM', payload: { itemId: ex.id } })}><Trash2 size={12} className="text-gray-400 hover:text-red-500"/></button></div>
                                      </div>
                                  ))
                                 }
                             </div>
                             <div className="bg-[#f6ea8c] p-2 rounded text-center border-2 border-[#492540] flex justify-between px-4 items-center"><span className="text-xs font-bold text-[#492540]">ç¸½æ”¯å‡º</span><span className="text-xl font-black text-[#c03546] font-mono">Â¥ {totalExpense.toLocaleString()}</span></div>
                         </div>
                       </Card>
                       <Card className="p-0 overflow-hidden">
                         <div className="bg-[#c03546] p-3 text-white font-bold flex items-center gap-2"><Calculator size={18}/> åˆ†å¸³è¨ˆç®—æ©Ÿ</div>
                         <div className="p-4 bg-white">
                             <div className="flex gap-2 mb-3">
                               <div className="flex-1"><label className="text-xs font-bold text-gray-500 mb-1 block">ç¸½é‡‘é¡</label><input type="number" placeholder="Â¥" className="w-full p-2 border-2 border-gray-300 rounded font-mono font-bold bg-white text-black" onChange={e=>setSplitTotal(e.target.value)}/></div>
                               <div className="w-24"><label className="text-xs font-bold text-gray-500 mb-1 block">äººæ•¸</label><input type="number" placeholder="äºº" className="w-full p-2 border-2 border-gray-300 rounded font-mono font-bold bg-white text-black" onChange={e=>setSplitPeople(e.target.value)}/></div>
                             </div>
                             <div className="bg-[#f6ea8c] p-3 rounded-lg text-center border-2 border-[#492540]"><span className="text-xs font-bold text-[#492540]">æ¯äººæ‡‰ä»˜ (ç„¡æ¢ä»¶é€²ä½)</span><div className="text-2xl font-black text-[#c03546] font-mono">Â¥ {splitTotal && splitPeople ? Math.ceil(splitTotal / splitPeople) : 0}</div></div>
                         </div>
                       </Card>
                       <a href="https://translate.google.com/?sl=ja&tl=zh-TW" target="_blank" rel="noreferrer" className="block bg-white p-4 rounded-xl border-2 border-[#492540] shadow-sm flex items-center justify-between hover:bg-gray-50">
                         <div className="flex items-center gap-3 font-bold text-[#492540]"><Languages className="text-[#00A3E0]" /> Google ç¿»è­¯ (æ—¥ â‡„ ä¸­)</div><ArrowRight size={16} className="text-gray-400"/>
                       </a>
                    </div>
                  )}

                  {/* Debug Panel */}
                  <div className="debug-console">
                    <div className="font-bold border-b border-gray-600 mb-1 flex justify-between">
                        <span>ğŸ”§ é™¤éŒ¯é¢æ¿</span>
                        <button onClick={() => setLogs([])} className="text-xs text-gray-400 hover:text-white">æ¸…é™¤</button>
                    </div>
                    {logs.length === 0 ? <div className="text-gray-500 italic">ç­‰å¾…ç´€éŒ„...</div> : logs.map((log, i) => <div key={i}>{log}</div>)}
                  </div>
                </div>
              </main>

              {/* FAB */}
              {(activeTab === 'SHOPPING' || activeTab === 'GEAR' || activeTab === 'TOOLS') && (
                <button 
                  onClick={() => {
                    if (activeTab === 'SHOPPING') setAddShopModal({ show: true });
                    else if (activeTab === 'GEAR') setAddCheckModal({ show: true });
                    else if (activeTab === 'TOOLS') setAddExpenseModal({ show: true });
                  }}
                  className="fixed bottom-24 right-4 bg-[#c03546] text-white p-4 rounded-full shadow-[4px_4px_0px_0px_#492540] border-2 border-[#492540] active:translate-y-1 active:shadow-none z-50 transition-transform hover:scale-105"
                >
                  <Plus size={24} strokeWidth={3} />
                </button>
              )}

              {/* Bottom Nav */}
              <nav className="flex-none bg-white border-t-2 border-[#492540] pb-safe pt-2 px-4 flex justify-between z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] fixed bottom-0 left-0 right-0 max-w-md mx-auto">
                {[{ id: 'QUESTS', icon: MapPin, label: 'è¡Œç¨‹' }, { id: 'ITEMS', icon: Star, label: 'å¿…è²·' }, { id: 'SHOPPING', icon: ShoppingBag, label: 'æ¸…å–®' }, { id: 'GEAR', icon: Briefcase, label: 'æº–å‚™' }, { id: 'TOOLS', icon: Calculator, label: 'å·¥å…·' }].map(tab => (
                  <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center gap-1 p-2 transition-all ${activeTab === tab.id ? 'text-[#c03546] -translate-y-2 scale-110' : 'text-gray-400 hover:text-gray-600'}`}>
                    <tab.icon size={24} strokeWidth={activeTab === tab.id ? 3 : 2} />
                    <span className="text-[10px] font-bold">{tab.label}</span>
                  </button>
                ))}
              </nav>

              {/* Modals - (ç•¥ç‚ºç°¡åŒ–ï¼Œå› ç‚ºèˆ‡åŸç‰ˆç›¸åŒï¼Œåƒ…ä¿ç•™å®Œæ•´æ€§) */}
              {addShopModal.show && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center sm:p-4">
                  <form onSubmit={handleAddNewShoppingItem} className="bg-white rounded-t-xl sm:rounded-xl border-2 border-[#492540] p-5 w-full max-w-md shadow-xl animate-slide-up">
                     <div className="flex justify-between items-center mb-4"><h3 className="font-black text-lg text-[#c03546]">æ–°å¢è³¼ç‰©æ¸…å–®</h3><button type="button" onClick={() => setAddShopModal({show:false})}><X/></button></div>
                     <div className="space-y-3">
                       <div><label className="text-xs font-bold text-gray-500">å•†å“åç¨±</label><input name="name" placeholder="e.g. EVEæ­¢ç—›è—¥" className="w-full p-3 border-2 border-gray-300 rounded-xl font-bold bg-white text-black" autoFocus required/></div>
                       <div><label className="text-xs font-bold text-gray-500">å‚™è¨» (è¦æ ¼/å£å‘³)</label><input name="note" placeholder="e.g. è—è‰²åŒ…è£" className="w-full p-3 border-2 border-gray-300 rounded-xl font-bold bg-white text-black"/></div>
                       <div><label className="text-xs font-bold text-gray-500">æ•¸é‡</label><input name="count" type="number" defaultValue="1" className="w-full p-3 border-2 border-gray-300 rounded-xl font-bold bg-white text-black"/></div>
                     </div>
                     <button type="submit" className="w-full bg-[#c03546] text-white py-3 rounded-lg font-bold mt-4 shadow-[2px_2px_0px_0px_#000] active:translate-y-[1px] active:shadow-none">ç¢ºèªæ–°å¢</button>
                  </form>
                </div>
              )}

              {addCheckModal.show && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center sm:p-4">
                  <form onSubmit={addChecklistItem} className="bg-white rounded-t-xl sm:rounded-xl border-2 border-[#492540] p-5 w-full max-w-md shadow-xl animate-slide-up">
                     <div className="flex justify-between items-center mb-4"><h3 className="font-black text-lg text-[#c03546]">æ–°å¢æª¢æŸ¥é …ç›®</h3><button type="button" onClick={() => setAddCheckModal({show:false})}><X/></button></div>
                     <div className="space-y-3">
                       <div><label className="text-xs font-bold text-gray-500">é …ç›®åç¨±</label><input name="text" placeholder="e.g. è½‰æ¥é ­" className="w-full p-3 border-2 border-gray-300 rounded-xl font-bold bg-white text-black" autoFocus required/></div>
                     </div>
                     <button type="submit" className="w-full bg-[#c03546] text-white py-3 rounded-lg font-bold mt-4 shadow-[2px_2px_0px_0px_#000] active:translate-y-[1px] active:shadow-none">ç¢ºèªæ–°å¢</button>
                  </form>
                </div>
              )}

              {addExpenseModal.show && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center sm:p-4">
                  <form onSubmit={handleAddExpense} className="bg-white rounded-t-xl sm:rounded-xl border-2 border-[#492540] p-5 w-full max-w-md shadow-xl animate-slide-up">
                     <div className="flex justify-between items-center mb-4"><h3 className="font-black text-lg text-[#00A3E0]">æ–°å¢æ¶ˆè²»ç´€éŒ„</h3><button type="button" onClick={() => setAddExpenseModal({show:false})}><X/></button></div>
                     <div className="space-y-3">
                       <div><label className="text-xs font-bold text-gray-500">é …ç›®</label><input name="title" placeholder="e.g. ç« é­šç‡’" className="w-full p-3 border-2 border-gray-300 rounded-xl font-bold bg-white text-black" autoFocus required/></div>
                       <div><label className="text-xs font-bold text-gray-500">é‡‘é¡ (æ—¥å¹£)</label><input name="amount" type="number" placeholder="e.g. 800" className="w-full p-3 border-2 border-gray-300 rounded-xl font-bold bg-white text-black" required/></div>
                       <div>
                         <label className="text-xs font-bold text-gray-500">ä»˜æ¬¾äºº</label>
                         <select name="payer" className="w-full p-3 border-2 border-gray-300 rounded-xl font-bold bg-white text-black">
                            {PAYERS.map(p => <option key={p} value={p}>{p}</option>)}
                         </select>
                       </div>
                     </div>
                     <button type="submit" className="w-full bg-[#00A3E0] text-white py-3 rounded-lg font-bold mt-4 shadow-[2px_2px_0px_0px_#000] active:translate-y-[1px] active:shadow-none">è¨˜å¸³</button>
                  </form>
                </div>
              )}

              {showSyncModal && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                  <div className="bg-white rounded-xl border-2 border-[#492540] p-5 w-full max-w-xs shadow-xl animate-bounce-slight">
                    <h3 className="font-black text-lg mb-2 text-[#00A3E0] flex items-center gap-2"><Users size={20}/> æ—…ç¨‹åŒæ­¥</h3>
                    <p className="text-sm text-gray-600 mb-4">è¼¸å…¥å…±åŒä»£ç¢¼ï¼Œèˆ‡å®¶äººæœ‹å‹å³æ™‚åŒæ­¥è¡Œç¨‹èˆ‡æ¸…å–®ã€‚</p>
                    
                    {tripId ? (
                        <div className="space-y-3">
                            <div className="bg-gray-100 p-2 rounded text-center font-mono font-bold text-xl tracking-widest border border-gray-300">{tripId}</div>
                            <button onClick={handleLeaveTrip} className="w-full py-2 rounded font-bold bg-[#c03546] text-white flex items-center justify-center gap-1"><LogOut size={16}/> é€€å‡ºåŒæ­¥æ¨¡å¼</button>
                            <button onClick={() => setShowSyncModal(false)} className="w-full py-2 rounded font-bold bg-gray-200 text-gray-600">é—œé–‰</button>
                        </div>
                    ) : (
                        <div className="space-y-3">
                            <input 
                                type="text" 
                                placeholder="è¼¸å…¥ä»£ç¢¼ (e.g. OSAKA2025)" 
                                className="w-full p-2 border-2 border-gray-300 rounded font-bold text-center uppercase text-black"
                                value={syncInput}
                                onChange={e => setSyncInput(e.target.value.toUpperCase())}
                            />
                            <button onClick={handleJoinTrip} className="w-full py-2 rounded font-bold bg-[#00A3E0] text-white">åŠ å…¥æ—…ç¨‹</button>
                            <button onClick={() => setShowSyncModal(false)} className="w-full py-2 rounded font-bold bg-gray-200 text-gray-600">å–æ¶ˆ</button>
                        </div>
                    )}
                  </div>
                </div>
              )}

              {/* Edit, Delete, Rec Modals ä¿æŒä¸è®Š ... */}
              {/* Delete Modal (Universal) */}
              {deleteModal.show && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                  <div className="bg-white rounded-xl border-2 border-[#492540] p-5 w-full max-w-xs shadow-xl animate-bounce-slight">
                    <h3 className="font-black text-lg mb-2 text-[#c03546]">ç¢ºèªåˆªé™¤ï¼Ÿ</h3>
                    <p className="text-sm text-gray-600 mb-4">åˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚</p>
                    <div className="flex gap-2">
                      <button onClick={() => setDeleteModal({show:false, type: null, payload: null})} className="flex-1 py-2 rounded font-bold bg-gray-200 text-gray-600">å–æ¶ˆ</button>
                      <button onClick={handleConfirmDelete} className="flex-1 py-2 rounded font-bold bg-[#c03546] text-white">åˆªé™¤</button>
                    </div>
                  </div>
                </div>
              )}

              {/* Edit Modal (Itinerary) */}
              {editModal.show && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center sm:p-4">
                  <form onSubmit={handleSaveEdit} className="bg-white rounded-t-xl sm:rounded-xl border-2 border-[#492540] p-5 w-full max-w-md shadow-xl animate-slide-up">
                     <div className="flex justify-between items-center mb-4"><h3 className="font-black text-lg">ç·¨è¼¯è¡Œç¨‹</h3><button type="button" onClick={() => setEditModal({show:false})}><X/></button></div>
                     <div className="space-y-3">
                       <div><label className="text-xs font-bold text-gray-500">æ™‚é–“</label><input name="time" defaultValue={editModal.activity.time} className="w-full p-2 border border-gray-300 rounded font-bold bg-white text-black"/></div>
                       <div><label className="text-xs font-bold text-gray-500">æ¨™é¡Œ</label><input name="title" defaultValue={editModal.activity.title} className="w-full p-2 border border-gray-300 rounded font-bold bg-white text-black"/></div>
                       <div><label className="text-xs font-bold text-gray-500">å‚™è¨»</label><textarea name="note" defaultValue={editModal.activity.note} className="w-full p-2 border border-gray-300 rounded text-sm h-20 bg-white text-black"/></div>
                     </div>
                     <button type="submit" className="w-full bg-[#492540] text-white py-3 rounded-lg font-bold mt-4">å„²å­˜è®Šæ›´</button>
                  </form>
                </div>
              )}

              {/* Add Itinerary Modal */}
              {addModal.show && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center sm:p-4">
                  <form onSubmit={handleAddActivity} className="bg-white rounded-t-xl sm:rounded-xl border-2 border-[#492540] p-5 w-full max-w-md shadow-xl animate-slide-up">
                     <div className="flex justify-between items-center mb-4"><h3 className="font-black text-lg text-[#c03546]">æ–°å¢è¡Œç¨‹ (Day {addModal.dayId})</h3><button type="button" onClick={() => setAddModal({show:false})}><X/></button></div>
                     <div className="space-y-3">
                       <div><label className="text-xs font-bold text-gray-500">æ™‚é–“</label><input name="time" placeholder="00:00" className="w-full p-2 border border-gray-300 rounded font-bold bg-white text-black" required/></div>
                       <div><label className="text-xs font-bold text-gray-500">è¡Œç¨‹æ¨™é¡Œ</label><input name="title" placeholder="è«‹è¼¸å…¥åœ°é»æˆ–æ´»å‹•" className="w-full p-2 border border-gray-300 rounded font-bold bg-white text-black" required/></div>
                       <div><label className="text-xs font-bold text-gray-500">Google Maps åœ°å€/é€£çµ (é¸å¡«)</label><input name="address" placeholder="è¼¸å…¥åœ°å€å¯å•Ÿç”¨å°èˆª" className="w-full p-2 border border-gray-300 rounded font-bold bg-white text-black"/></div>
                     </div>
                     <button type="submit" className="w-full bg-[#c03546] text-white py-3 rounded-lg font-bold mt-4 shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:translate-y-[1px] active:shadow-none">ç¢ºèªæ–°å¢</button>
                  </form>
                </div>
              )}

              {/* Add Recommendation Modal */}
              {addRecModal.show && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center sm:p-4">
                  <form onSubmit={handleAddRec} className="bg-white rounded-t-xl sm:rounded-xl border-2 border-[#492540] p-5 w-full max-w-md shadow-xl animate-slide-up">
                     <div className="flex justify-between items-center mb-4"><h3 className="font-black text-lg text-[#00A3E0]">æ–°å¢æ¨è–¦é …ç›®</h3><button type="button" onClick={() => setAddRecModal({show:false})}><X/></button></div>
                     <div className="space-y-3">
                       <div>
                          <label className="text-xs font-bold text-gray-500">å€åŸŸ</label>
                          <select name="areaKey" className="w-full p-2 border border-gray-300 rounded font-bold bg-white text-black">{INITIAL_RECOMMENDATIONS.map(r => <option key={r.areaKey} value={r.areaKey}>{r.areaName}</option>)}</select>
                       </div>
                       <div><label className="text-xs font-bold text-gray-500">åç¨±</label><input name="name" placeholder="e.g. å¿…åƒæ‹‰éºµ" className="w-full p-2 border border-gray-300 rounded font-bold bg-white text-black" required/></div>
                       <div>
                          <label className="text-xs font-bold text-gray-500">é¡å‹</label>
                          <select name="tag" className="w-full p-2 border border-gray-300 rounded font-bold bg-white text-black"><option value="ç¾é£Ÿ">ç¾é£Ÿ</option><option value="è³¼ç‰©">è³¼ç‰©</option><option value="è—¥å¦">è—¥å¦</option><option value="ä¼´æ‰‹ç¦®">ä¼´æ‰‹ç¦®</option></select>
                       </div>
                       <div><label className="text-xs font-bold text-gray-500">æè¿°</label><input name="desc" placeholder="e.g. å¾ˆå¤šäººæ’éšŠ" className="w-full p-2 border border-gray-300 rounded font-bold bg-white text-black"/></div>
                       <div><label className="text-xs font-bold text-gray-500">ç‡Ÿæ¥­æ™‚é–“</label><input name="hours" placeholder="e.g. 09:00-22:00" className="w-full p-2 border border-gray-300 rounded font-bold bg-white text-black"/></div>
                     </div>
                     <button type="submit" className="w-full bg-[#00A3E0] text-white py-3 rounded-lg font-bold mt-4 shadow-[2px_2px_0px_0px_#000] active:translate-y-[1px] active:shadow-none">åŠ å…¥æ¨è–¦</button>
                  </form>
                </div>
              )}

              {/* Edit Recommendation Modal */}
              {editRecModal.show && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center sm:p-4">
                  <form onSubmit={handleSaveRecEdit} className="bg-white rounded-t-xl sm:rounded-xl border-2 border-[#492540] p-5 w-full max-w-md shadow-xl animate-slide-up">
                     <div className="flex justify-between items-center mb-4"><h3 className="font-black text-lg text-[#00A3E0]">ç·¨è¼¯æ¨è–¦é …ç›®</h3><button type="button" onClick={() => setEditRecModal({show:false, areaKey:null, item:null})}><X/></button></div>
                     <div className="space-y-3">
                       <div><label className="text-xs font-bold text-gray-500">åç¨±</label><input name="name" defaultValue={editRecModal.item.name} className="w-full p-2 border border-gray-300 rounded font-bold bg-white text-black" required/></div>
                       <div>
                          <label className="text-xs font-bold text-gray-500">é¡å‹</label>
                          <select name="tag" defaultValue={editRecModal.item.tag} className="w-full p-2 border border-gray-300 rounded font-bold bg-white text-black"><option value="ç¾é£Ÿ">ç¾é£Ÿ</option><option value="è³¼ç‰©">è³¼ç‰©</option><option value="è—¥å¦">è—¥å¦</option><option value="ä¼´æ‰‹ç¦®">ä¼´æ‰‹ç¦®</option></select>
                       </div>
                       <div><label className="text-xs font-bold text-gray-500">æè¿°</label><input name="desc" defaultValue={editRecModal.item.desc} className="w-full p-2 border border-gray-300 rounded font-bold bg-white text-black"/></div>
                       <div><label className="text-xs font-bold text-gray-500">ç‡Ÿæ¥­æ™‚é–“</label><input name="hours" defaultValue={editRecModal.item.hours} className="w-full p-2 border border-gray-300 rounded font-bold bg-white text-black"/></div>
                     </div>
                     <button type="submit" className="w-full bg-[#00A3E0] text-white py-3 rounded-lg font-bold mt-4 shadow-[2px_2px_0px_0px_#000] active:translate-y-[1px] active:shadow-none">å„²å­˜æ¨è–¦</button>
                  </form>
                </div>
              )}
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>